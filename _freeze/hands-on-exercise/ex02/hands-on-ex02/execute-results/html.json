{
  "hash": "090f68829d1e4f06c2d149cd67f6d312",
  "result": {
    "markdown": "---\ntitle: \"Exercise 02 'Thematic Mapping and GeoVisualisation with R'\"\nauthor: \"Heng Kuan Xin\"\ndate: 2024-08-21\ndate-modified: 2024-08-24\nexecute:\n  eval: true\n  echo: true\n  freeze: true\n  output: true\n  warning: false\n  error: false\ntoc-depth: 5\n---\n\n\n(Copied from Exercise) Overview:\n\nIn general, thematic mapping involves the use of map symbols to visualize selected properties of geographic features that are not naturally visible, such as population, temperature, crime rate, and property prices, just to mention a few of them.\n\nGeovisualisation, on the other hand, works by providing graphical ideation to render a place, a phenomenon or a process visible, enabling human’s most powerful information-processing abilities – those of spatial cognition associated with our eye–brain vision system – to be directly brought to bear.\n\nIn this chapter, you will learn how to plot functional and truthful choropleth maps by using an R package called **tmap** package.\n\n### 1 Import packages\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\npacman::p_load(sf, tidyverse, tmap)\n```\n:::\n\n\n### 2 Import data\n\n------------------------------------------------------------------------\n\n(Copied from Exercise) Two data set will be used to create the choropleth map. They are:\n\n-   Master Plan 2014 Subzone Boundary (Web) (i.e. `MP14_SUBZONE_WEB_PL`) in ESRI shapefile format. It can be downloaded at [data.gov.sg](https://data.gov.sg/) This is a geospatial data. It consists of the geographical boundary of Singapore at the planning subzone level. The data is based on URA Master Plan 2014.\n\n-   Singapore Residents by Planning Area / Subzone, Age Group, Sex and Type of Dwelling, June 2011-2020 in csv format (i.e. `respopagesextod2011to2020.csv`). This is an aspatial data fie. It can be downloaded at [Department of Statistics, Singapore](https://www.singstat.gov.sg/) Although it does not contain any coordinates values, but it’s PA and SZ fields can be used as unique identifiers to geocode to `MP14_SUBZONE_WEB_PL` shapefile.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmpsz <- st_read(\n  dsn=\"data/geospatial/MasterPlan2014SubzoneBoundaryWebSHP\",\n  layer=\"MP14_SUBZONE_WEB_PL\")\n\n# mpsz\n\npopdata <- read_csv(\"data/aspatial/respopagesextod2011to2020/respopagesextod2011to2020.csv\", show_col_types = FALSE)\n\n# popdata\n# colnames(popdata)\n```\n:::\n\n\n### 3 Data Preparation\n\n------------------------------------------------------------------------\n\n#### Create Data Table for Year 2020\n\nWe want to plot a choropleth map using year 2020 values, by joining the population table with the masterplan subzone object.\n\nAim: Create a data table for year 2020 values, containing columns as shown:\n\n|     |     |       |                |      |       |            |\n|-----|-----|-------|----------------|------|-------|------------|\n| PA  | SZ  | YOUNG | ECONOMY ACTIVE | AGED | TOTAL | DEPENDENCY |\n\nTherefore, we will derive values for:\n\n-   YOUNG: age group 0 to 4 until age group 20 to 24,\n-   ECONOMY ACTIVE: age group 25-29 until age group 60-64,\n-   AGED: age group 65 and above,\n-   TOTAL: all age group, and\n-   DEPENDENCY: the ratio between young and aged against economy active group\n\n\n::: {.cell}\n\n```{.r .cell-code}\npopdata2020 <- popdata %>%\n  filter(Time==2020) %>%    # select rows where Time = 2020 \n  group_by(PA, SZ, AG) %>%  # group by PA, SZ, AG\n  summarise(`POP` = sum(`Pop`)) %>% # sum up the population within each group\n  ungroup() %>%              # ungroup table (which allows for further calculations\n                             # on individual rows)\n  pivot_wider(               # create new columns using values from AG as names\n    names_from=AG,           # and values from POP as values\n    values_from=POP)\n\ncolnames(popdata2020)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"PA\"          \"SZ\"          \"0_to_4\"      \"10_to_14\"    \"15_to_19\"   \n [6] \"20_to_24\"    \"25_to_29\"    \"30_to_34\"    \"35_to_39\"    \"40_to_44\"   \n[11] \"45_to_49\"    \"50_to_54\"    \"55_to_59\"    \"5_to_9\"      \"60_to_64\"   \n[16] \"65_to_69\"    \"70_to_74\"    \"75_to_79\"    \"80_to_84\"    \"85_to_89\"   \n[21] \"90_and_over\"\n```\n:::\n\n```{.r .cell-code}\npopdata2020 <- popdata2020 %>%\n  mutate(YOUNG = rowSums(.[3:6]) + rowSums(.[14])) %>% # add YOUNG = sum across the row where index = [3:6] and [15] \n  mutate(`ECONOMY ACTIVE` = rowSums(.[7:13]) + rowSums(.[15])) %>% # add ECONOMY ACTIVE\n  mutate(`AGED`= rowSums(.[16:21])) %>% # add AGED\n  mutate(`TOTAL`= rowSums(.[3:21])) %>% # add TOTAL\n  mutate(`DEPENDENCY` = (`YOUNG` + `AGED`)/`ECONOMY ACTIVE`) %>% # add DEPENDENCY\n  select(`PA`, `SZ`, `YOUNG`, `ECONOMY ACTIVE`, `AGED`, `TOTAL`, `DEPENDENCY`)\n\ncolnames(popdata2020)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"PA\"             \"SZ\"             \"YOUNG\"          \"ECONOMY ACTIVE\"\n[5] \"AGED\"           \"TOTAL\"          \"DEPENDENCY\"    \n```\n:::\n:::\n\n\n#### Join attribute and geospatial data (geolocational join)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# convert PA and SZ variable data to upper cases to match SUBZONE_N and PLN_AREA_N of mspz\npopdata2020 <- popdata2020 %>%\n  mutate_at(.vars = vars(PA, SZ),      # mutate at variables PA , SZ\n          .funs = list(toupper)) %>%   # apply function list(toupper)\n  filter(`ECONOMY ACTIVE` > 0)\n\n\n# left join by SUBZONE_N = SZ\nmpsz_pop2020 <- left_join(mpsz, popdata2020,\n                          by = c(\"SUBZONE_N\" = \"SZ\"))\n```\n:::\n\n\n#### Export/Write Data frame as RDS object\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Write to a R Data Serialization(RDS) file, which is useful for storing state of objects between R sessions\n\nwrite_rds(mpsz_pop2020, \"data/rds/mpszpop2020.rds\")\n```\n:::\n\n\n### 4 Choropleth Mapping Geospatial Data Using tmap\n\n------------------------------------------------------------------------\n\n#### Overview Examples\n\n##### Quick Method of Visualising using qtm()\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set tmap mode to \"plot\" , alternatively use view for interactive plot\ntmap_mode(\"plot\")\nqtm(mpsz_pop2020,\n    fill = \"DEPENDENCY\")\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\n# mpsz_pop2020\n```\n:::\n\n\n##### Adjusting layouts, borders, and adding furnitures (e.g. compass, scale)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(mpsz_pop2020)+\n  tm_fill(\"DEPENDENCY\", \n          style = \"quantile\", \n          palette = \"Blues\",\n          title = \"Dependency ratio\") +\n  tm_layout(main.title = \"Distribution of Dependency Ratio by planning subzone\",\n            main.title.position = \"center\",\n            main.title.size = 1.2,\n            legend.height = 0.45, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_borders(alpha = 0.5) +\n  tm_compass(type=\"8star\", size = 2) +\n  tm_scale_bar() +\n  tm_grid(alpha =0.2) +\n  tm_credits(\"Source: Planning Sub-zone boundary from Urban Redevelopment Authorithy (URA)\\n and Population data from Department of Statistics DOS\", \n             position = c(\"left\", \"bottom\"))\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n##### Basic Steps to create a Choropleth Map. Using tm_polygons() vs tm_fill() + tm_borders()\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# st_make_valid(mpsz_pop2020)\n# tmap_options(check.and.fix = TRUE)\n# tmap_mode(\"plot\")\n\n# Step 1a: Plain Polygon\ntm1 <- tm_shape(mpsz_pop2020) + tm_polygons() + tm_layout(\n  main.title = \"Step 1a: Plain Polygon\",\n  main.title.position = \"center\",\n  main.title.size = 0.7)\n\n# Step 1b: Coloured Polygon using DEPENDENCY\ntm2 <- tm_shape(mpsz_pop2020)+ tm_polygons(\"DEPENDENCY\") + tm_layout(\n  main.title = \"Step 1b: Coloured Polygon using DEPENDENCY\",\n  main.title.position = \"center\",\n  main.title.size = 0.7,\n  legend.width = 5.0)\n\n# Alternatively, Step 2a: Coloured Fill using DEPENDENCY instead of Polygon\ntm3 <- tm_shape(mpsz_pop2020)+ tm_fill(\"DEPENDENCY\") + tm_layout(\n  main.title = \"Alternatively, Step 2a: Coloured Fill using DEPENDENCY instead of Polygon\",\n  main.title.position = \"center\",\n  main.title.size = 0.7)\n\n# Step 2b: Add in borders on top of Fill\ntm4 <- tm_shape(mpsz_pop2020) + tm_fill(\"DEPENDENCY\") + tm_borders(lwd = 0.1, alpha = 1) + tm_layout(\n  main.title = \"Step 2b: Add in borders on top of Fill\",\n  main.title.position = \"center\",\n  main.title.size = 0.7)\n\n# Specify Data Classification (Quantile, n=5)\ntm5 <- tm_shape(mpsz_pop2020) + tm_fill(\"DEPENDENCY\", n = 5, style = \"quantile\") + tm_borders(alpha = 0.5) + tm_layout(\n  main.title = \"Specify Data Classification (Quantile, n=5)\",\n  main.title.position = \"center\",\n  main.title.size = 0.7)\n\n# Specify Data Classification (Equal range), n=5)\ntm6 <- tm_shape(mpsz_pop2020) + tm_fill(\"DEPENDENCY\", n = 5, style = \"equal\") + tm_borders(alpha = 0.5) + tm_layout(\n  main.title = \"Specify Data Classification (Equal range), n=5)\",\n  main.title.position = \"center\",\n  main.title.size = 0.7)\n\n# Plot all maps together\ntmap_arrange(tm1,tm2,tm3,tm4,tm5,tm6)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n#### Determining Data Classification Methods and Number of Classes\n\n![Data Classification Guide](images/data_classification_guide.jpg){fig-align=\"center\" width=\"489\"}\n\nGiven that Dependency ranges from 0 to 19, let us try n = 1 + 3.32 \\* log(20) \\~= 5.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = mpsz_pop2020, \n       mapping = aes(x = `DEPENDENCY`)\n       ) +\n  geom_histogram()\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n\n```{.r .cell-code}\n  # geom_dotplot()\n  # geom_freqpoly()\n```\n:::\n\n\nBy plotting the distribution of DEPENDENCY, we see that there is an outlier that is significantly larger. To avoid misrepresenting the data, we should avoid equal intervals, quantile, and standard deviation. A good choice may be Jenks (Natural Breaks), or other manual classifications.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Visualise the attribute value range\n\nsummary(mpsz_pop2020$DEPENDENCY)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's \n 0.0000  0.6519  0.7025  0.7742  0.7645 19.0000      92 \n```\n:::\n:::\n\n\n#### Custom Intervals/Ranges for Data Classification\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(mpsz_pop2020)+\n  tm_fill(\"DEPENDENCY\",\n          breaks = c(0, 0.60, 0.70, 0.80, 0.90, 1.00)) +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n#### Adjusting palette, Inverting Palette\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Using colour palette Blues instead of default\n\ntm_shape(mpsz_pop2020)+\n  tm_fill(\"DEPENDENCY\",\n          n = 6,\n          style = \"quantile\",\n          palette = \"Blues\") +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n## Changing palette to Greens. Use -Greens for inverse colouring\n\ntm_shape(mpsz_pop2020)+\n  tm_fill(\"DEPENDENCY\",\n          n = 6,\n          style = \"quantile\",\n          palette = \"-Greens\") +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n#### Adjusting Legend properties\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(mpsz_pop2020)+\n  tm_fill(\"DEPENDENCY\", \n          style = \"jenks\", \n          palette = \"Blues\", \n          legend.hist = TRUE, \n          legend.is.portrait = TRUE,\n          legend.hist.z = 0.1) +\n  tm_layout(main.title = \"Distribution of Dependency Ratio by planning subzone \\n(Jenks classification)\",\n            main.title.position = \"center\",\n            main.title.size = 1,\n            legend.height = 0.45, \n            legend.width = 0.35,\n            legend.outside = FALSE,\n            legend.position = c(\"right\", \"bottom\"),\n            frame = FALSE) +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n#### Adjusting tmap_style()\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_style(\"classic\")\n\n# other available styles are: \"gray\", \"natural\", \"cobalt\", \"col_blind\", \"albatross\", \"beaver\", \"bw\", \"classic\", \"watercolor\" \n\ntm_shape(mpsz_pop2020)+\n  tm_fill(\"DEPENDENCY\", \n          style = \"quantile\", \n          palette = \"-Greens\") +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n#### More Examples\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(mpsz_pop2020)+\n  tm_fill(\"DEPENDENCY\", \n          style = \"quantile\", \n          palette = \"Blues\",\n          title = \"No. of persons\") +\n  tm_layout(main.title = \"Distribution of Dependency Ratio \\nby planning subzone\",\n            main.title.position = \"center\",\n            main.title.size = 1.2,\n            legend.height = 0.45, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_borders(alpha = 0.5) +\n  tm_compass(type=\"8star\", size = 2) +\n  tm_scale_bar(width = 0.15) +\n  tm_grid(lwd = 0.1, alpha = 0.2) +\n  tm_credits(\"Source: Planning Sub-zone boundary from Urban Redevelopment Authorithy (URA)\\n and Population data from Department of Statistics DOS\", \n             position = c(\"left\", \"bottom\"))\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntmap_style(\"white\")\n```\n:::\n\n\n### 5 Showing Multiple Maps\n\n------------------------------------------------------------------------\n\n#### Method 1: specify within tm_fill()\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# note two maps created, one using \"YOUNG\", the other \"AGED\"\ntm_shape(mpsz_pop2020)+\n  tm_fill(c(\"YOUNG\", \"AGED\"),\n          style = \"equal\", \n          palette = \"Blues\") +\n  tm_layout(legend.position = c(\"right\", \"bottom\")) +\n  tm_borders(alpha = 0.5) +\n  tmap_style(\"white\")\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(mpsz_pop2020)+ \n  tm_polygons(c(\"DEPENDENCY\",\"AGED\"),\n          style = c(\"equal\", \"quantile\"), \n          palette = list(\"Blues\",\"Greens\")) +\n  tm_layout(legend.position = c(\"right\", \"bottom\"))\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n#### Method 2: Using tm_facets(by = ATTRIBUTE)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(mpsz_pop2020) +\n  tm_fill(\"DEPENDENCY\",\n          style = \"quantile\",\n          palette = \"Blues\",\n          thres.poly = 0) + \n  tm_facets(by=\"REGION_N\", \n            free.coords=TRUE, \n            drop.shapes=TRUE) +\n  tm_layout(legend.show = FALSE,\n            title.position = c(\"center\", \"center\"), \n            title.size = 20) +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-20-1.png){width=672}\n:::\n:::\n\n\n#### Method 3: Using tmap_arrange(map1, map2, ...)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nyoungmap <- tm_shape(mpsz_pop2020)+ \n  tm_polygons(\"YOUNG\", \n              style = \"quantile\", \n              palette = \"Blues\")\n\nagedmap <- tm_shape(mpsz_pop2020)+ \n  tm_polygons(\"AGED\", \n              style = \"quantile\", \n              palette = \"Blues\")\n\ntmap_arrange(youngmap, agedmap, asp=1, ncol=2)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-21-1.png){width=672}\n:::\n:::\n\n\n### 6 Specifying Specific Region in Map to Show\n\n------------------------------------------------------------------------\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_shape(mpsz_pop2020[mpsz_pop2020$REGION_N==\"CENTRAL REGION\", ])+\n  tm_fill(\"DEPENDENCY\", \n          style = \"quantile\", \n          palette = \"Blues\", \n          legend.hist = TRUE, \n          legend.is.portrait = TRUE,\n          legend.hist.z = 0.1) +\n  tm_layout(legend.outside = TRUE,\n            legend.height = 0.45, \n            legend.width = 5.0,\n            legend.position = c(\"right\", \"bottom\"),\n            frame = FALSE) +\n  tm_borders(alpha = 0.5)\n```\n\n::: {.cell-output-display}\n![](hands-on-ex02_files/figure-html/unnamed-chunk-22-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "hands-on-ex02_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}